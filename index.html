<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MIDNIGHT SIGNAL: V5.0 (VISUAL)</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=VT323&display=swap');

        :root { --bg: #050505; --term: #33ff00; --alert: #ff3300; --cyan: #00ffff; }
        
        body { margin: 0; background-color: var(--bg); color: var(--term); font-family: 'VT323', monospace; overflow: hidden; }

        /* --- UI SCREENS (Login/Lobby) --- */
        .screen { display: none; padding: 20px; text-align: center; z-index: 100; position: relative; }
        .active { display: block; }
        
        input, button { background: #000; border: 2px solid var(--term); color: var(--term); font-family: 'VT323', monospace; font-size: 1.5rem; width: 100%; max-width: 400px; padding: 10px; margin: 10px 0; }
        button:hover { background: var(--term); color: #000; cursor: pointer; }

        /* --- THE VISUAL ENGINE (Game Screen) --- */
        #viewport {
            position: absolute; top: 0; left: 0; width: 100vw; height: 100vh;
            background: #000; overflow: hidden; perspective: 500px;
            display: none; /* Hidden until game starts */
        }
        #viewport.active { display: block; }

        /* LAYER 1: THE ROAD */
        .layer-road {
            position: absolute; top: 50%; left: 50%; width: 200%; height: 200%;
            transform: translate(-50%, -50%) rotateX(60deg);
            background: linear-gradient(90deg, transparent 45%, #333 45%, #333 55%, transparent 55%), linear-gradient(#000 0%, #111 100%);
            background-size: 100px 100px;
            animation: drive 0.4s linear infinite;
            z-index: 1; opacity: 0.5;
        }
        .stopped .layer-road { animation: none; } /* Class to stop car */

        @keyframes drive { from { background-position: 0 0; } to { background-position: 0 100px; } }

        /* LAYER 2: THE MONSTER (Hidden by default) */
        .layer-monster {
            position: absolute; top: 40%; left: 50%; transform: translate(-50%, -50%);
            z-index: 2; display: none; filter: drop-shadow(0 0 10px red);
        }
        .glitch-art { color: red; font-size: 8px; white-space: pre; animation: twitch 0.2s infinite; font-weight: bold; }
        @keyframes twitch { 0% { transform: translate(0,0); } 25% { transform: translate(-2px, 1px); } 50% { transform: translate(2px, -1px); } 75% { transform: translate(-1px, 2px); } 100% { transform: translate(0,0); } }

        /* LAYER 3: DASHBOARD / HUD */
        .layer-dash {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 10;
            background: radial-gradient(circle, transparent 50%, #000 130%);
            pointer-events: none;
            box-shadow: inset 0 0 100px #000;
        }

        /* FLOATING TEXT (The Story) */
        .hud-text {
            position: absolute; top: 30%; left: 50%; transform: translateX(-50%);
            z-index: 20; color: #33ff00; font-size: 1.8rem; text-shadow: 0 0 5px #33ff00;
            text-align: center; width: 90%; pointer-events: none;
            opacity: 0; transition: opacity 0.5s;
        }
        .hud-text.show { opacity: 1; animation: floatUp 4s forwards; }
        @keyframes floatUp { 0% { top: 35%; opacity: 0; } 10% { top: 30%; opacity: 1; } 90% { top: 30%; opacity: 1; } 100% { top: 25%; opacity: 0; } }

        /* CONTROLS (Buttons on screen) */
        #game-controls {
            position: absolute; bottom: 30px; left: 0; width: 100%; text-align: center; z-index: 30;
        }
        .btn-game { width: 45%; max-width: 200px; display: inline-block; background: rgba(0,0,0,0.8); }
        
        .role-badge { position: absolute; top: 10px; left: 10px; background: #000; border: 1px solid var(--term); padding: 5px; z-index: 30; font-size: 1rem; }

    </style>
</head>
<body>

    <div id="screen-login" class="screen active">
        <h1 style="font-size:3rem; margin-bottom:0;">MIDNIGHT SIGNAL</h1>
        <p>VISUAL ENGINE V5.0</p>
        <input type="text" id="username" placeholder="CODENAME" maxlength="12">
        <input type="text" id="room-code" placeholder="FREQUENCY (ROOM A1)" maxlength="5">
        <button onclick="joinGame()">CONNECT</button>
    </div>

    <div id="screen-lobby" class="screen">
        <h2>FREQUENCY: <span id="lobby-code">---</span></h2>
        <div id="p-list" style="text-align:left; border:1px dashed #333; padding:10px; margin-bottom:20px;"></div>
        
        <div id="host-controls" style="display:none;">
            <button onclick="addBot()" style="border-color: var(--cyan); color: var(--cyan);">+ DEPLOY SYNTHETIC</button>
            <button onclick="startGame()">INITIATE MISSION</button>
        </div>
        <p id="wait-msg">WAITING FOR COMMANDER...</p>
        <button onclick="forceReset()" style="margin-top:50px; border-color:#555; color:#555;">[DEBUG] RESET ROOM</button>
    </div>

    <div id="viewport">
        <div class="role-badge">ID: <span id="my-role-display">---</span></div>

        <div class="layer-road" id="road"></div>

        <div class="layer-monster" id="monster">
<pre class="glitch-art">
   .---.
  ( @ @ )
   \ W /
  /|   |\
 //|   |\\
    ||| 
</pre>
        </div>

        <div class="layer-dash"></div>
        <div id="hud-text" class="hud-text">SYSTEM ONLINE...</div>

        <div id="game-controls">
            <div id="decision-box" style="display:none;">
                <p style="color:var(--alert); background:black; display:inline-block; padding:5px;">⚠️ DECISION REQUIRED ⚠️</p><br>
                <button class="btn-game" style="border-color:var(--alert); color:var(--alert);" onclick="makeChoice('STOP')">SLAM BRAKES</button>
                <button class="btn-game" onclick="makeChoice('DRIVE')">FLOOR IT</button>
            </div>
            <button id="replay-btn" onclick="resetRoom()" style="display:none; border-color:yellow; color:yellow; width:200px;">REBOOT SYSTEM</button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, set, get, onValue, update, remove, onDisconnect } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDu4i16gFrPaazfSXhjksjCdsr9QlxBMfug",
            authDomain: "apex-447e2.firebaseapp.com",
            databaseURL: "https://apex-447e2-default-rtdb.firebaseio.com",
            projectId: "apex-447e2",
            storageBucket: "apex-447e2.firebasestorage.app",
            messagingSenderId: "838605000780",
            appId: "1:838605000780:web:82806b59ec17543caae4e9"
        };

        const db = getDatabase(initializeApp(firebaseConfig));
        
        let myId = "AGENT-" + Math.floor(Math.random()*1000);
        let myRoom = "", myRole = "";
        let isHost = false;
        
        const ROLES = ["DRIVER", "MEDIUM", "OPERATOR", "MECHANIC"];

        // --- JOIN & LOBBY ---
        window.joinGame = function() {
            const nameInput = document.getElementById('username').value.toUpperCase();
            if(nameInput) myId = nameInput;
            myRoom = document.getElementById('room-code').value.toUpperCase() || "A1";

            const pRef = ref(db, `v5/${myRoom}/players/${myId}`);
            set(pRef, { name: myId, role: "PENDING", joinedAt: Date.now() });
            onDisconnect(pRef).remove();

            document.getElementById('screen-login').classList.remove('active');
            document.getElementById('screen-lobby').classList.add('active');
            document.getElementById('lobby-code').innerText = myRoom;
            listenGame();
        }

        function listenGame() {
            // Watch Players (Auto-Host)
            onValue(ref(db, `v5/${myRoom}/players`), snap => {
                const players = snap.val() || {};
                const ids = Object.keys(players).sort((a,b) => players[a].joinedAt - players[b].joinedAt);
                
                if(ids.length > 0) {
                    isHost = (myId === ids[0]); // First player is host
                    document.getElementById('p-list').innerHTML = ids.map(id => `<div>${id} ${id === ids[0] ? '★' : ''}</div>`).join('');
                    document.getElementById('host-controls').style.display = isHost ? 'block' : 'none';
                    document.getElementById('wait-msg').style.display = isHost ? 'none' : 'block';
                }

                // Check for Role & Game Start
                if(players[myId] && players[myId].role !== "PENDING") {
                    myRole = players[myId].role;
                    launchVisualEngine();
                }
            });

            // Watch Events
            onValue(ref(db, `v5/${myRoom}/game_event`), snap => {
                const ev = snap.val();
                if(ev === "CHAP_1_START") playChapter1();
                if(ev === "RESULT_STOP") showOutcome("STOP");
                if(ev === "RESULT_DRIVE") showOutcome("DRIVE");
                if(ev === "RESET") location.reload();
            });
        }

        // --- HOST ACTIONS ---
        window.startGame = function() {
            get(ref(db, `v5/${myRoom}/players`)).then(snap => {
                const ids = Object.keys(snap.val());
                ids.forEach((id, i) => update(ref(db, `v5/${myRoom}/players/${id}`), { role: ROLES[i%ROLES.length] }));
                update(ref(db, `v5/${myRoom}`), { game_event: "CHAP_1_START" });
            });
        }
        
        window.addBot = function() {
            const botId = "SYNTH-" + Math.floor(Math.random()*90);
            set(ref(db, `v5/${myRoom}/players/${botId}`), { name: botId, role: "PENDING", joinedAt: Date.now() });
        }
        
        window.forceReset = function() { remove(ref(db, `v5/${myRoom}`)); location.reload(); }
        window.resetRoom = function() { update(ref(db, `v5/${myRoom}`), { game_event: "RESET" }); }

        // --- VISUAL ENGINE LOGIC ---
        function launchVisualEngine() {
            document.getElementById('screen-lobby').classList.remove('active');
            document.getElementById('viewport').classList.add('active');
            document.getElementById('my-role-display').innerText = myRole;

            // THE TWIST: Only Medium sees the monster
            if(myRole === "MEDIUM") {
                document.getElementById('monster').style.display = 'block';
                showText("SIGHTING: SPECTRAL VISION ACTIVE");
            } else {
                document.getElementById('monster').style.display = 'none';
                showText("SYSTEM: STANDARD OPTICS ONLINE");
            }
        }

        function playChapter1() {
            setTimeout(() => showText("ENTERING BLACKWOOD TUNNEL..."), 2000);
            setTimeout(() => {
                showText("WARNING: OBSTACLE AHEAD!");
                // Only Driver gets buttons
                if(myRole === "DRIVER") {
                    setTimeout(() => document.getElementById('decision-box').style.display = 'block', 1000);
                } else {
                    setTimeout(() => showText("SHOUT AT THE DRIVER!"), 2000);
                }
            }, 5000);
        }

        window.makeChoice = function(choice) {
            update(ref(db, `v5/${myRoom}`), { game_event: choice === 'STOP' ? 'RESULT_STOP' : 'RESULT_DRIVE' });
        }

        function showOutcome(choice) {
            document.getElementById('decision-box').style.display = 'none';
            if(choice === "STOP") {
                document.getElementById('viewport').classList.add('stopped'); // Stop road animation
                showText("BRAKES ENGAGED. CREATURE AVOIDED.");
            } else {
                // Shake effect (visualized by text)
                showText("IMPACT CONFIRMED. HULL DAMAGED.");
            }
            if(isHost) document.getElementById('replay-btn').style.display = 'inline-block';
        }

        function showText(msg) {
            const el = document.getElementById('hud-text');
            el.classList.remove('show');
            void el.offsetWidth; // Trigger reflow
            el.innerText = msg;
            el.classList.add('show');
        }
    </script>
</body>
</html>
